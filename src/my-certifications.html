<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/app-datepicker/app-datepicker-dialog.html">
<link rel="import" href="app-styles.html">
<link rel="import" href="components/ks-info-card.html">


<dom-module id="my-certifications">
  <template>
    <style include="app-styles">
      #myProgress {
        width: 100%;
        background-color: #ddd;
      }

      #myBar {
        width: 1%;  
        height: 30px;
        background-color: #4CAF50;
      }
      input{
        padding: 7px;
      }
      label{
        margin-right: 5px;
      }
      #container-formacion{
        width: 95%;
        height: 100%;
        border-radius: 50px;
        border: 0px solid lightgray;
        display: flex;
        justify-content: space-between;
      }
      .col{
        width: 50%;
        padding: 20px;
        display: inline-block;
      }
      .cont-input{
        padding: 7% 0 0 0;
      }
      .btn-send{
        padding: 5px;
        background-color: gray;
        color: white;
        width: 90px;
        height: 25px;
        margin-top: 15px;
      }
      .listData{
        margin-top: 7px;
      }
    </style>

    <div id="">
    <h1 class="data-header-name" >Certificaciones</h1>
     <iron-form id="formCertifications">
      <form id="container-formacion">
        <div class="col">
          <div class="cont-input">
            <paper-input type="text" name="certificacion" required label="Nombre de la Certificación" value="{{currentItem.certificacion}}"></paper-input>
          </div>

          <div class="cont-input">
            <paper-input type="text" name="entidad" required label="Entidad Emisora" value="{{currentItem.entidad}}"></paper-input>
          </div>

          <div class="cont-input">
            <paper-input type="text" name="licencia" required label="Nº de Licencia" value="{{currentItem.licencia}}"></paper-input>
          </div>

          <div class="cont-input">
            <paper-input type="text" name="url" required label="URL" value="{{currentItem.url}}"></paper-input>
          </div>
        </div>
        <div class="col">
          <div class="cont-input">
            <div class="datepicker-dialog" id="desdeDate">
                <span>Fecha Inicio</span>
                <paper-button disabled>[[desde]]</paper-button>
                <paper-icon-button icon="icons:today" on-tap="_openDialogInit"></paper-icon-button>
                <app-datepicker-dialog id="desde"
                  format="dd/mm/yyyy"
                  date="{{desde}}"
                  locale="es-ES">
                </app-datepicker-dialog>
              </div>
          </div>

          <div class="cont-input">
            <div class="datepicker-dialog" id="hastaDate">
                <span>Fecha Fin</span>
                <paper-button disabled>[[hasta]]</paper-button>
                <paper-icon-button icon="icons:today" on-tap="_openDialogFinal"></paper-icon-button>
                <app-datepicker-dialog id="hasta"
                  format="dd/mm/yyyy"
                  date="{{hasta}}"
                  locale="es-ES">
                </app-datepicker-dialog>
              </div>
          </div>

          <div class="cont-input">
            <paper-checkbox name="permanente" checked="{{permanente}}">Esta certificacion no vence</paper-checkbox>
          </div>
        </div>
      </form>
      <div class="save-buttons">
        <paper-button class="paper-button-k" raised on-click="_addData">Añadir</paper-button>
        <paper-button class="paper-button-k save-and-continue" raised on-click="_saveData">guardar y continuar</paper-button>
      </div>
      </iron-form>
    </div>

    <template is="dom-repeat" items="{{certifications}}">
        <ks-info-card 
            title="{{item.certificacion}}" 
            on-remove-item="_removeItem"
            on-edit-item="_editItem"
            aditional-data="{{item}}"
            index="{{index}}">
        </ks-info-card>
    </template>

  </template>

  <script>
    (function appShell(customElements){
      'use strict';

      class MyCertifications extends Polymer.Element {
        static get is() { return 'my-certifications'; }
        static get properties() {
          return {
            certifications: {
              type: Array,
              value: []
            },
            permanente: {
              type: Boolean,
              value: false
            },
            currentItem: {
              type: Object,
              value: {
                certificacion: '',
                entidad: '',
                licencia: '',
                url: '',
                desde:'',
                hasta:''
              }
            }
          }
        }

        connectedCallback() {
            super.connectedCallback();
        }

        _openDialogInit(event) {
            this.$.desde.open();
        }

        _openDialogFinal(event) {
            this.$.hasta.open();
        }

         _resetData(event) {
          this.$.hastaDate.style.display = 'block';
          this.permanente = false;
          this.$.formCertifications.reset();
        }

        _formatJson() {
          const form = this.$.formCertifications.serializeForm();
          form.permanente = this.permanente;
          form.desde = this.desde;
          if (this.permanente == false) {
            form.hasta = this.hasta;
          }
          return form;
        }
      
      _saveData(){
        this.certifications.forEach(element => {
          delete element.edit;
        });

        this.dispatchEvent(new CustomEvent('save-info',{
          bubbles: true,
          detail:{
            key: 'certifications',
            data: this.certifications
          }
        }));
      }

      _removeItem(event) {
        const index = event.detail.index;
        this.splice('certifications', index, 1);
      }

      _editItem(event) {
        this._removeItem(event);
        const item = event.detail.item;
        this.set('currentItem', item);
        this.set('permanente', item.permanente);
      }


      _addData(event) {
        const validate = this.$.formCertifications.validate();
        if (validate) {
          const form = this._formatJson();
          this.push('certifications', {
              certificacion: form.certificacion,
              desde: form.desde,
              hasta: form.hasta,
              entidad: form.entidad,
              licencia: form.licencia,
              permanente: form.permanente,
              url: form.url
            }
          )
          this._resetData();
        }
      }

      }
      customElements.define(MyCertifications.is, MyCertifications);
    })(window.customElements);
  </script>
</dom-module>
