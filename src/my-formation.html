<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/app-datepicker/app-datepicker-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="app-styles.html">
<link rel="import" href="components/ks-info-card.html">


<dom-module id="my-formation">
  <template>
    <style include="app-styles">
      #myProgress {
        width: 100%;
        background-color: #ddd;
      }

      #myBar {
        width: 1%;
        height: 30px;
        background-color: #4CAF50;
      }
      input{
        padding: 7px;
      }
      label{
        margin-right: 5px;
      }
      #container-formacion{
        width: 99%;
        height: 100%;
        border-radius: 50px;
        border: 0px solid lightgray;
        display: flex;
        justify-content: space-between;
      }
      .col{
        width: 50%;
        padding: 20px;
        display: inline-block;
      }
      .cont-input{
        padding: 5% 0 0 0;
      }
      .btn-send{
        padding: 5px;
        background-color: gray;
        color: white;
        width: 90px;
        height: 25px;
        margin-top: 15px;
      }
      .cont-input.radio {
        margin-bottom: 10px;
      }
      .dropdown{
        width: 100%;
      }
    </style>

    <div id="">
    <h1 class="data-header-name" >Formación Académica</h1>
     <iron-form id="formFormation">
      <form id="container-formacion">
        <div class="col">
          <div class="cont-input">
            <paper-input type="text" name="institucion" required label="Institución" value="{{currentItem.institucion}}"></paper-input>
          </div>

          <div class="cont-input">
            <paper-input type="text" name="titulacion" required label="Titulación" value="{{currentItem.titulacion}}"></paper-input>
          </div>

          <div class="cont-input">
            <paper-dropdown-menu-light label="Estatus" class="dropdown">
              <paper-listbox slot="dropdown-content" class="dropdown-content" selected={{level}} attr-for-selected="myvalue" required>
                  <template is="dom-repeat" items="[[levels]]" as="level">
                      <paper-item myvalue="[[level]]">{{level}}</paper-item>
                  </template>
              </paper-listbox>
          </paper-dropdown-menu-light>
          <input is="iron-input" name="level" type="hidden" value$="[[level]]" required>
          </div>
        </div>
        <div class="col">
            <div class="cont-input">
                <div class="datepicker-dialog" id="desdeDate">
                    <span>Fecha Inicio</span>
                    <paper-button disabled>[[desde]]</paper-button>
                    <paper-icon-button icon="icons:today" on-tap="_openDialogInit"></paper-icon-button>
                    <app-datepicker-dialog id="desde"
                      format="dd/mm/yyyy"
                      date="{{desde}}"
                      locale="es-ES">
                    </app-datepicker-dialog>
                </div>
            </div>
            <div class="cont-input">
              <div class="datepicker-dialog" id="hastaDate">
                  <span>Fecha Fin</span>
                  <paper-button disabled>[[hasta]]</paper-button>
                  <paper-icon-button icon="icons:today" on-tap="_openDialogFinal"></paper-icon-button>
                  <app-datepicker-dialog id="hasta"
                    format="dd/mm/yyyy"
                    date="{{hasta}}"
                    locale="es-ES">
                  </app-datepicker-dialog>
                </div>
            </div>
            <div class="cont-input radio">
              <paper-checkbox name="actual" checked="{{actual}}">En curso</paper-checkbox>
            </div>
        </div>
      </form>
      <div class="save-buttons">
        <paper-button class="paper-button-k" raised on-click="_addData">Añadir</paper-button>
        <paper-button class="paper-button-k save-and-continue" raised on-click="_saveData">guardar y continuar</paper-button>
      </div>
     </iron-form>
    </div>

    <template is="dom-repeat" items="{{formation}}">
        <ks-info-card 
            title="{{item.institucion}}" 
            on-remove-item="_removeItem"
            on-edit-item="_editItem"
            aditional-data="{{item}}"
            index="{{index}}">
        </ks-info-card>
    </template>

  </template>

  <script>
    (function appShell(customElements){
      'use strict';

      class MyFormation extends Polymer.Element {
        static get is() { return 'my-formation'; }
        static get properties() {
          return {
            formation: {
              type: Array,
              value: []
            },
            levels: {
              type: Array,
              value: ['Pasante', 'Titulado', 'Trunco']
            },
            level: {
              type: Number,
              value: 0,
              notify: true
            },
            actual: {
              type: Boolean,
              value: false
            },
            currentItem: {
              type: Object,
              value: {
                institucion: '',
                titulacion: '',
                level : '',
                actual: '',
                desde: '',
                hasta: ''
              }
            }
          }
        }

        connectedCallback() {
            super.connectedCallback();
        }

        _openDialogInit(event) {
            this.$.desde.open();
        }

        _openDialogFinal(event) {
            this.$.hasta.open();
        }

        _resetData(event) {
            this.$.hastaDate.style.display = 'block';
            this.$.formFormation.reset();
        }
        
        _orderData(){
          let newOrder = [];
          this.formation.forEach(element => {
            
          });
        }

        _formatJson() {
          const form = this.$.formFormation.serializeForm();
          form.desde = this.desde;
          form.hasta = this.hasta;
          form.level = this.level;
          if(this.level == '0'){
            form.level = 'Titulado';
          }
          if(this.level == '1'){
            form.level = 'Pasante';
          }else{
            form.level = 'Trunco';
          }
          if(form.actual == 'on'){
            form.actual = 'si';
            form.hasta = '';
          }else{
            form.actual = 'no';
          }
          return form;
        }
      
        _saveData(){
          this.formation.forEach(element => {
            delete element.edit;
          });


          this.dispatchEvent(new CustomEvent('save-info',{
            bubbles: true,
            detail:{
              key: 'formation',
              data: this.formation
            }
          }));
        }

        _removeItem(event) {
          const index = event.detail.index;
          this.splice('formation', index, 1);
        }

        _editItem(event) {
          this._removeItem(event);
          const item = event.detail.item;
          this.level = item.level;
          this.set('currentItem', item);

        }

        _addData(event) {
          const validate = this.$.formFormation.validate();
          if (validate) {
            const form = this._formatJson();
            
            this.push('formation', {
                actual: form.actual,
                desde: form.desde,
                hasta: form.hasta,
                institucion: form.institucion,
                level: form.level,
                titulacion: form.titulacion
              }
            )
            this._resetData();
          }
        }

      }
      customElements.define(MyFormation.is, MyFormation);
    })(window.customElements);
  </script>
</dom-module>
